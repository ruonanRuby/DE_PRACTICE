# 指南

## 总体方案

1. 通过传统数据仓库的维度建模的方式进行建模。
2. 使用SQL进行数据转换。
3. 使用airflow进行任务编排。
4. 使用 BI 可视化报表。

## 分析

需求中的指标都是围绕订单数量或者订单中的商品数作为度量展开的，而订单也是业务活动中的事件，因此将订单作为事实。对于维度，根据指标，产品的属性、订单状态都可能是维度。而指标中还包含了订单创建时间、完成时间，因此这些时间也是维度。

为了简单期间，本例中将所有产品的属性作为一个维度。由于产品的属性会有变化，因此使用缓慢变化维对待，这里使用type-2。

数据集每天更新一次，这里采用批处理的方式，每天处理一次。

## 实现

由于事实依赖维度，因此先从维度开始。

### 创建时间维度

由于时间维度是通用的，可以在各个批处理只用通用。可以创建一个单独的DAG，生成时间维度。

### 创建产品维度

产品的源数据是CSV，首先将其标准化，再将其导入DWH中的staging表里，比如STG_PRODUCTS。然后将其导入维度表DIM_PRODUCTS中。包括

1. 等待产品数据CSV可用
2. 标准化CSV文件
3. 创建STG_PRODUCTS
4. 将CSV导入STG_PRODUCTS
5. 将STG_PRODUCTS导入DIM_PRODUCTS并合并

注意：由于产品数据里边没有产品创建时间。

### 创建订单属性维度

订单状态也是维度。创建 DIM_ORDERS 表，包括status和timestamp。由于status变化，也作为type-2缓慢变化维。

问题：是否真的需要订单属性维度？

### 创建创建订单事实

这里需要考虑，是使用哪种事实表：事务事实表，周期快照事实表，还是累积快照事实表？还是根据不同情况，创建多个不同的事实表？

注意：订单里边有事件的时间戳。同一个订单，可能在每天有多次更新。

### 创建库存事实

库存数量是不可累加的，因此需要使用快照事实表。而我们需要周期性的库存指标。
### 构建图表

在 BI 工具（比如 Metabase ）中构建图表，可视化指标。

## 实践经验

在实际处理数据中，基于可读性、扩展性、可追踪性，甚至回滚的需求有如下的实践：

1. 在数据中，添加处理批次（比如使用批处理的日期）。
2. 在数据中，添加处理时间、源系统ID等元数据。
3. 使用代理键作为主键，而不是元数据中的主键。主键可使用自增键，但如果要重新处理数据，主键可能发生变化。因此也有使用摘要值生成确定主键的方式（比如使用源系统ID+源数据中的主键，使用SHA1算法生成），但要注意不能碰撞。
4. 记录字段的Checksum。当检查数据是否变化时，比较多个值可能效率会降低。可以给每条数据增加一个checksum值，比较checksum是否变化即可。
5. 空值处理。NULL在SQL中无法直接通过`<>`比较。可以给把 NULL 值设置为该类型的特殊的值；不过，在PostgreSQL中，可以通过`expression IS DISTINCT FROM expression`比较。